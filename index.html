<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Globe</title>

	<style type="text/css">
            html {height: 100%}
	    body { margin: 0; overflow:hidden; height:100%}

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                /*margin-top: 50vh;
                transform: translateY(-50%);*/
            }
            #menuDiv {position: absolute; top:0px; margin-left: 0px;}


        </style>
        <meta charset="UTF-8">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="viewerDiv"></div>
        <script src="dist/itowns2.js"> </script>
        <script type="text/javascript">

            var initCenter = { longitude:4.827620, latitude: 45.771049, altitude: 25000};

            // iTowns namespace defined here
            var viewerDiv = document.getElementById("viewerDiv");

            var scene = itowns.viewer.createSceneGlobe(initCenter, viewerDiv) ;

            itowns.viewer.addImageryLayer({
                protocol:   "wmts",
                id:         "Ortho",
                url:        "http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
                updateStrategy: {
                    type: 0, /* see LayerUpdateStrategy.js */
                    options: {}
                },
                options: {
                    name: "ORTHOIMAGERY.ORTHOPHOTOS",
                    mimetype: "image/jpeg",
                    tileMatrixSet: "PM",
                    tileMatrixSetLimits: {
                        "2": {
                            "minTileRow": 0,
                            "maxTileRow": 4,
                            "minTileCol": 0,
                            "maxTileCol": 4
                        },
                        "3": {
                            "minTileRow": 0,
                            "maxTileRow": 8,
                            "minTileCol": 0,
                            "maxTileCol": 8
                        },
                        "4": {
                            "minTileRow": 0,
                            "maxTileRow": 6,
                            "minTileCol": 0,
                            "maxTileCol": 16
                        },
                        "5": {
                            "minTileRow": 0,
                            "maxTileRow": 32,
                            "minTileCol": 0,
                            "maxTileCol": 32
                        },
                        "6": {
                            "minTileRow": 1,
                            "maxTileRow": 64,
                            "minTileCol": 0,
                            "maxTileCol": 64
                        },
                        "7": {
                            "minTileRow": 3,
                            "maxTileRow": 28,
                            "minTileCol": 0,
                            "maxTileCol": 128
                        },
                        "8": {
                            "minTileRow": 7,
                            "maxTileRow": 256,
                            "minTileCol": 0,
                            "maxTileCol": 256
                        },
                        "9": {
                            "minTileRow": 15,
                            "maxTileRow": 512,
                            "minTileCol": 0,
                            "maxTileCol": 512
                        },
                        "10": {
                            "minTileRow": 31,
                            "maxTileRow": 1024,
                            "minTileCol": 0,
                            "maxTileCol": 1024
                        },
                        "11": {
                            "minTileRow": 62,
                            "maxTileRow": 2048,
                            "minTileCol": 0,
                            "maxTileCol": 2048
                        },
                        "12": {
                            "minTileRow": 125,
                            "maxTileRow": 4096,
                            "minTileCol": 0,
                            "maxTileCol": 4096
                        },
                        "13": {
                            "minTileRow": 2739,
                            "maxTileRow": 4628,
                            "minTileCol": 41,
                            "maxTileCol": 7917
                        },
                        "14": {
                            "minTileRow": 5478,
                            "maxTileRow": 9256,
                            "minTileCol": 82,
                            "maxTileCol": 15835
                        },
                        "15": {
                            "minTileRow": 10956,
                            "maxTileRow": 8513,
                            "minTileCol": 165,
                            "maxTileCol": 31670
                        },
                        "16": {
                            "minTileRow": 21912,
                            "maxTileRow": 37026,
                            "minTileCol": 330,
                            "maxTileCol": 63341
                        },
                        "17": {
                            "minTileRow": 43825,
                            "maxTileRow": 74052,
                            "minTileCol": 660,
                            "maxTileCol": 126683
                        },
                        "18": {
                            "minTileRow": 87651,
                            "maxTileRow": 48105,
                            "minTileCol": 1320,
                            "maxTileCol": 253366
                        },
                        "19": {
                            "minTileRow": 175302,
                            "maxTileRow": 294060,
                            "minTileCol": 170159,
                            "maxTileCol": 343473
                        },
                        "20": {
                            "minTileRow": 376733,
                            "maxTileRow": 384679,
                            "minTileCol": 530773,
                            "maxTileCol": 540914
                        }
                    }
                }
            });

        itowns.viewer.update();



        // THIS IS AN EXAMPLE OF INTERFACE TO INTERACT WITH ITOWNS
        var Menu = function() {
            this.CloudsIR = false;
            this.SatelliteAnimation = false;
            this.RealisticLighting = false;
            this.StreetLevelImagery = false;
            this.KML = false;
            this.AnimateTime = false;
            this.Orbit = false;
            this.api = function(){};
            this.api2 = function(){};
            this.api3 = function(){};
        };

        var text = new Menu();
        var gui = new dat.GUI( { autoPlace: false});
        gui.domElement.id = 'menuDiv';
        viewerDiv.appendChild(gui.domElement);

        var config = scene.getMap().layersConfiguration;

        var colorGui = gui.addFolder('Color Layers');
        var colorLayers = scene.getMap().layersConfiguration.getColorLayers();
        for(var i in colorLayers) {
            var layer = colorLayers[i];

            var folder = colorGui.addFolder(layer.id);
            folder.add( { visible: true }, 'visible').onChange(function(value) {
                itowns.viewer.setLayerVisibility(this, value);
            }.bind(layer.id));
            folder.add( { opacity: 1.0 }, 'opacity').min(0.0).max(1.0).onChange(function(value) {
                itowns.viewer.setLayerOpacity(this, value);
            }.bind(layer.id));
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        var elevationGui = gui.addFolder('Elevation Layers');
        var elevationLayers = config.getElevationLayers();
        for(var i in elevationLayers) {
            var layer = elevationLayers[i];

            var folder = elevationGui.addFolder(layer.id);
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        var conf3dtiles = {
            representations: "lod1,lod2",
            poids: "1,2",
            reload: function() {
                //var baseUrl = "http://localhost:9090/"
                //var suffix = "getScene?city=lyon&layer=buildings&representations=" + conf3dtiles.representations + "&weights=" + conf3dtiles.poids;
                var baseUrl = "http://localhost:8080/";
                var suffix = "data/lyonTileSetOk/Tiles/newTileset.json";

                //var suffix = "data/TilesetWithDiscreteLOD/tileset.json";

                itowns.viewer.load3dtiles(baseUrl, suffix);
            }
        };
        gui.add(conf3dtiles, "representations");
        gui.add(conf3dtiles, "poids");
        gui.add(conf3dtiles, "reload");

        if(false) {
            var f2 = gui.addFolder('Atmosphere');

            f2.open();

            f2.add(text, 'CloudsIR').onChange(function(newValue) {
                itowns.viewer.showClouds(newValue);
            });

            f2.add(text, 'SatelliteAnimation').onChange(function(newValue) {
                itowns.viewer.showClouds(true, newValue);
            });

            f2.add(text, 'RealisticLighting').onChange(function(newValue) {
                itowns.viewer.setRealisticLightingOn(newValue);
            });

            f2.add(text, 'AnimateTime').onChange(function(newValue) {
                itowns.viewer.animateTime(newValue);
            });

            f2.add(text, 'Orbit').onChange(function(newValue) {
                itowns.viewer.orbit(newValue);
            });


            f2.add(text, 'StreetLevelImagery').onChange(function(newValue) {
                itowns.viewer.setStreetLevelImageryOn(newValue);
            });
        }


        var removeLayer = function(nameLayer) {
            if(itowns.viewer.removeImageryLayer(nameLayer)) {
                var controllerTodelete = [];

                for (var i in gui.__controllers) {
                    var controller = gui.__controllers[i];

                    if(controller.property === nameLayer || controller.property === nameLayer + '_Opacity') {
                        controllerTodelete.push(controller);
                    }
                }

                for (var i in controllerTodelete) {
                    gui.remove(controllerTodelete[i]);
                }
            }
        }

        var controller;

        itowns.viewer.addEventListener('globe-loaded', function() {
            console.log("Globe Loaded");
        });

        itowns.viewer.addEventListener('Layer-removed', function(event) {
            console.log("Layer " + event.layer +  " removed");
        });

        </script>
    </body>
</html>
